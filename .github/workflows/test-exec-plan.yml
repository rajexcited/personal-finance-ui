# Build and Test - make sure code has no issues
#
name: Test Execution Plan

# list of trigger events https://docs.github.com/en/actions/writing-workflows/choosing-when-your-workflow-runs/events-that-trigger-workflows
on:
  # regardless of branch, run this default workflow to verify code
  workflow_dispatch:
    inputs:
      milestone-version:
        required: true
        type: string
        description: milestone version to release prod. e.g. 0.1.2
      testplan-type:
        required: true
        type: choice
        description: type of test plan to generate
        options:
          - regression
          - sanity

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  ISSUE_LABELS: "regression,test plan"

jobs:
  validate_milestone:
    name: validate Milestone
    runs-on: ubuntu-latest
    outputs:
      milestone-details: ${{ steps.milestone-details.outputs.details }}
    if: ${{ github.event.inputs.testplan-type != 'sanity' }}
    steps:
      - run: echo milestone version = ${{ github.event.inputs.milestone-version }}
      - name: Get Milestone
        id: get-milestone-issue
        uses: actions/github-script@v7
        # https://octokit.github.io/rest.js/v21/
        with:
          script: |
            const label = 'v${{ github.event.inputs.milestone-version }}';
            console.log("milestone label: ", label);
            const listMilestonesResponse = await github.rest.issues.listMilestones({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open'
            });
            console.log("listMilestonesResponse: ", listMilestonesResponse);
            const matchedMilestone = listMilestonesResponse.data.find(m => m.title === label);
            if (!matchedMilestone) {
              throw new Error(`Milestone with label "${label}" is not found`);
            }
            console.log("found matching milestone: ", matchedMilestone);
            const details = {
              issueNumber: matchedMilestone.number,
              title: matchedMilestone.title,
              issueUrl: matchedMilestone.html_url,
              milestoneId: matchedMilestone.id,
              dueOn: matchedMilestone.due_on.split('T')[0],
              openIssues: matchedMilestone.open_issues,
              closedIssues: matchedMilestone.closed_issues,
              issueBaseUrl: `${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/issues`
            };
            core.setOutput('details', details);
      - name: Get Milestone Branch
        id: get-milestone-branch
        uses: actions/github-script@v7
        with:
          script: |
            const branch = `milestone/v${{ github.event.inputs.milestone-version }}`;
            const getBranchResponse = await github.rest.repos.getBranch({
                owner: context.repo.owner,
                repo: context.repo.repo,
                branch: branch
              });
            console.log("getBranchResponse: ", getBranchResponse);
            core.setOutput('details', {
                branchName: getBranchResponse.data.name, 
                branchUrl: getBranchResponse.data._links.html
              });
      - id: milestone-details
        uses: actions/github-script@v7
        with:
          script: |
            const milestoneIssueDetails = ${{ steps.get-milestone-issue.outputs.details }};
            const milestoneBranchDetails = ${{ steps.get-milestone-branch.outputs.details }};
            core.setOutput('details', {
              ...milestoneIssueDetails,
              ...milestoneBranchDetails
              });
      - name: Display outputs
        run: |
          echo "Milestone results: ${{ steps.milestone-details.outputs.details }}"
          echo "Milestone issue Url: ${{ steps.milestone-details.outputs.details.issueUrl }}"

  validate_regression:
    name: Validate Regression Test Plan Exists
    runs-on: ubuntu-latest
    if: ${{ github.event.inputs.testplan-type == 'regression' }}
    permissions:
      issues: read
    steps:
      - name: Search Regression Test Plan Issue
        id: get-regression-testplan-issue
        uses: actions/github-script@v7
        with:
          script: |
            const milestoneLabel = 'v${{ github.event.inputs.milestone-version }}';
            const listIssuesResponse = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              labels: process.env.ISSUE_LABELS.split(","),
              state: 'open'
            });
            console.log("listIssuesResponse: ", listIssuesResponse);
            const foundRegressionIssue = listIssuesResponse.data.find(issue => {
              console.log("issue title: ", issue.title);
              if (issue.title.includes("Regression") && issue.milestone.title === milestoneLabel) {
                return true;
              }
              return false;
            });
            if (foundRegressionIssue) {
              console.error(`Found Issue title: ${foundRegressionIssue.title}`);
              console.error(`Regression Test plan Issue link: ${foundRegressionIssue.html_url}`);
              throw new Error(`Regression Test Plan Issue[${foundRegressionIssue.number}] has already been existed for milestone ${milestoneLabel}`);
            }

  generate_regression:
    name: Generate Regression Test Plan
    runs-on: ubuntu-latest
    needs:
      - validate_milestone
      - validate_regression
    permissions:
      issues: write
    steps:
      - name: Display milestone details
        run: |
          echo validate mileston output json=${{ needs.validate_milestone.outputs.milestone-details }}
      - name: Checkout
        uses: actions/checkout@v4
      - name: Setup python
        uses: actions/setup-python@v5
        with:
          cache: "pip" # caching pip dependencies
          python-version: "3.13"
      - run: python --version
      - run: pip install -r .github/scripts/requirements.txt
      - run: pwd
      - id: generate
        run: |
          echo generating regression test plan from test case files
          milestone_result=${{ toJson(needs.validate_milestone.outputs.milestone-details) }}
          gen_regression_testplan="regression-testplan-$(date +'%Y%m%d%H%M%S')"
          python .github/scripts/regression_testplan.py --generate --template-path .github/ISSUE_TEMPLATE/regression_test_plan_template.md --generated-filename "$gen_regression_testplan" --tc-dir "test-cases" --milestone-details "$milestone_result"
      - name: Display outputs of Testplan generated
        run: |
          echo "Regression Test Plan Title: ${{ steps.generate.outputs.title }}"
          echo "Regression Test Plan File Path: ${{ steps.generate.outputs.file_path }}"
          echo "Regression Test Plan Name: ${{ steps.generate.outputs.name }}"
      - name: Create Regression Test Plan Issue
        id: create-testplan-issue
        uses: actions/github-script@v7
        with:
          script: |
            // https://octokit.github.io/rest.js/v21/#issues
            const testPlanTitle = ${{ steps.generate.outputs.title }};
            const testPlanPath = ${{ steps.generate.outputs.file_path }};
            const milestoneDetails = ${{ needs.validate_milestone.outputs.milestone-details }};
            const fs = require('fs');
            const regressionTestplanContent = fs.readFileSync(testPlanPath, 'utf8');
            const issueResponse = await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: testPlanTitle,
              body: regressionTestplanContent,
              milestone: milestoneDetails.milestoneId,
              labels: process.env.ISSUE_LABELS.split(",")
            });
            console.log("issueResponse: ", issueResponse);
            core.setOutput('issue-number', issueResponse.data.number);
            const lockIssueResponse = await github.rest.issues.lock({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueResponse.data.number
            });
            console.log("lockIssueResponse: ", lockIssueResponse);
            console.log("Regression Test Plan Issue created: ", issueResponse.data.html_url);
            console.log("Regression Test Plan Issue Number: ", issueResponse.data.number);
